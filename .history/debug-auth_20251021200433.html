<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug</title>
</head>
<body>
    <h1>Authentication Debug Tool</h1>
    
    <div id="status"></div>
    
    <button onclick="checkAuth()">Check Authentication</button>
    <button onclick="login()">Test Login</button>
    <button onclick="clearAuth()">Clear Auth</button>
    <button onclick="testAPI()">Test API Call</button>
    
    <div id="output" style="margin-top: 20px; font-family: monospace; white-space: pre-wrap;"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function checkAuth() {
            log('=== Checking Authentication ===');
            
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user_data');
            
            log('Token exists: ' + (token ? 'YES' : 'NO'));
            if (token) {
                log('Token length: ' + token.length);
                log('Token start: ' + token.substring(0, 20) + '...');
                
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        log('Token payload: ' + JSON.stringify(payload, null, 2));
                        
                        const now = Math.floor(Date.now() / 1000);
                        const exp = payload.exp;
                        log('Current time: ' + now);
                        log('Token expires: ' + exp);
                        log('Time until expiry: ' + (exp - now) + ' seconds');
                        log('Is expired: ' + (exp < now));
                    } else {
                        log('Invalid token format');
                    }
                } catch (e) {
                    log('Error parsing token: ' + e.message);
                }
            }
            
            log('User data exists: ' + (userData ? 'YES' : 'NO'));
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    log('User: ' + JSON.stringify(user, null, 2));
                } catch (e) {
                    log('Error parsing user data: ' + e.message);
                }
            }
            
            // Check cookies
            const cookies = document.cookie;
            log('Cookies: ' + cookies);
        }

        async function login() {
            log('=== Testing Login ===');
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'ghallymuhammad2@gmail.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                log('Login response: ' + JSON.stringify(data, null, 2));
                
                if (data.success && data.data.token) {
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('user_data', JSON.stringify(data.data.user));
                    document.cookie = `token=${data.data.token}; path=/; max-age=86400; SameSite=strict`;
                    log('Token stored successfully');
                } else {
                    log('Login failed or no token received');
                }
            } catch (error) {
                log('Login error: ' + error.message);
            }
        }

        function clearAuth() {
            log('=== Clearing Authentication ===');
            localStorage.removeItem('token');
            localStorage.removeItem('user_data');
            document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            log('Authentication cleared');
        }

        async function testAPI() {
            log('=== Testing API Call ===');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('No token found');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8000/api/user/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('API Response status: ' + response.status);
                const data = await response.json();
                log('API Response: ' + JSON.stringify(data, null, 2));
            } catch (error) {
                log('API error: ' + error.message);
            }
        }

        // Initial check
        checkAuth();
    </script>
</body>
</html>
